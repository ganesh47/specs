name: specs guard (issue/ADR/wiki)

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  guard:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate spec issue, ADR discussion, wiki link, and ADR approval
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          pr_body=$(gh pr view "$PR_NUMBER" --json body --jq .body)
          issue=$(printf "%s" "$pr_body" | grep -oE "#[0-9]+" | head -n1 | tr -d '#')
          if [ -z "${issue:-}" ]; then
            echo "Missing spec issue reference (#123) in PR body."
            exit 1
          fi

          issue_body=$(gh issue view "$issue" --json body,state --jq '{body:.body,state:.state}')
          issue_state=$(printf "%s" "$issue_body" | jq -r .state)
          if [ "$issue_state" != "OPEN" ]; then
            echo "Spec issue #$issue is not open (state=$issue_state)."
            exit 1
          fi
          issue_text=$(printf "%s" "$issue_body" | jq -r .body)

          adr_url_pr=$(printf "%s" "$pr_body" | grep -oE "https://github.com/.+/discussions/[0-9]+" | head -n1 || true)
          wiki_url_pr=$(printf "%s" "$pr_body" | grep -oE "https://github.com/.+/wiki/[^ )\"]+" | head -n1 || true)
          adr_url_issue=$(printf "%s" "$issue_text" | grep -oE "https://github.com/.+/discussions/[0-9]+" | head -n1 || true)
          wiki_url_issue=$(printf "%s" "$issue_text" | grep -oE "https://github.com/.+/wiki/[^ )\"]+" | head -n1 || true)

          adr_url=${adr_url_pr:-$adr_url_issue}
          wiki_url=${wiki_url_pr:-$wiki_url_issue}

          if [ -z "${adr_url:-}" ]; then
            echo "Missing ADR discussion URL in PR or issue body."
            exit 1
          fi
          if [ -z "${wiki_url:-}" ]; then
            echo "Missing wiki URL in PR or issue body."
            exit 1
          fi

          repo_owner="${GITHUB_REPOSITORY%/*}"
          repo_name="${GITHUB_REPOSITORY#*/}"
          adr_number=$(printf "%s" "$adr_url" | sed -E 's#.*/discussions/([0-9]+).*#\1#')
          adr_comments=$(gh api graphql -f query='query($owner:String!,$name:String!,$number:Int!){repository(owner:$owner,name:$name){discussion(number:$number){comments(first:50){nodes{bodyText}}}}}' -f owner="$repo_owner" -f name="$repo_name" -F number="$adr_number" | jq -r '..|.bodyText? // empty')
          if ! printf "%s" "$adr_comments" | grep -iq "approved"; then
            echo "ADR discussion does not contain an approval marker."
            exit 1
          fi

          review_decision=$(gh pr view "$PR_NUMBER" --json reviewDecision --jq .reviewDecision)
          if [ "${review_decision:-}" = "CHANGES_REQUESTED" ]; then
            echo "PR has pending changes requested; resolve review comments before sync/merge."
            exit 1
          fi

          echo "Guard checks passed: issue #$issue open, ADR link present/approved, wiki link present."
