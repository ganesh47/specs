name: sample specs coverage

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm install -g specs
      - run: specs coverage
        working-directory: examples/sample-app

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python deps for Semgrep
        run: python3 -m pip install --upgrade pip semgrep
      - name: SAST (Semgrep OSS)
        run: semgrep --config p/ci --error --metrics=off

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
      - name: Install OSV-Scanner
        run: |
          go install github.com/google/osv-scanner/cmd/osv-scanner@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
      - name: SCA (OSV-Scanner)
        run: osv-scanner -r examples/sample-app

      - name: Install Gitleaks
        run: go install github.com/zricethezav/gitleaks/v8@latest
      - name: Secrets (Gitleaks)
        run: gitleaks detect --no-banner --redact --source .

      - name: IaC (Checkov)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: examples/sample-app
          quiet: true
